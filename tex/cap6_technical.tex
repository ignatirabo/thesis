\section{Aspectos Técnicos}

En esta sección discutiremos los aspectos técnicos de \lift.
Comenzaremos discutiendo su funcionamiento básico y de ahí escalaremos a los detalles más profundos. 

\subsection{TyTree}

En términos generales Lift es un fixpoint sobre un telescopio con un gran análisis por casos sobre los tipos.
Entonces surge un problema: ¿Cómo podemos hacer pattern matching en los tipos de manera sintáctica?
La solución es utilizar un reflejo de los mismos, de manera de que podamos expresarlos de manera inductiva.

\begin{lstlisting}
Inductive TyTree : Type :=
| tyTree_val {m : MTele} (T : MTele_Ty m) : TyTree
| tyTree_M (T : Type) : TyTree
| tyTree_MFA {m : MTele} (T : MTele_Ty m) : TyTree
| tyTree_In (s : Sort) {m : MTele} (F : accessor m -> s) : TyTree
| tyTree_imp (T : TyTree) (R : TyTree) : TyTree
| tyTree_FATele {m : MTele} (T : MTele_Ty m)
  (F : \forall t : MTele_val T, TyTree) : TyTree
| tyTree_FATele1 (m : MTele) (F : \forall (T : MTele_Ty m), TyTree) : TyTree
| tyTree_FAValue (T : Type) (F : T -> TyTree) : TyTree
| tyTree_FAType (F : Type -> TyTree) : TyTree
| tyTree_base (T : Type) : TyTree
.
\end{lstlisting}

Con este tipo podemos reescribir todas las signaturas de funciones. Varios de los constructores, como por ejemplo
\lstinline{tyTree_MFA} o \lstinline{tyTree_FATele}, tendrán sentido más adelante, dado que reflejan elementos en
funciones lifteadas.

Una de las propiedades principales de este reflejo es que a primera vista parece que un tipo puede escribirse de múltiples formas en \lstinline{TyTree}, pero los tratamos de manera distinta y por eso podemos plantear una biyección
entre \lstinline{Type} y \lstinline{TyTree}.
% TODO: Igual la función to_tree es monádica y no funciona bien.

Utilizaremos \lstinline{Const$_t$} para expresar \lstinline{tyTree_Const}, donde \lstinline{Const} representa alguno de los nombres de los constructores de la definición de \lstinline{TyTree}. 

Ahora tomaremos una función \lstinline{f} e iremos modificando si signatura para mostrar este reflejo de tipos.
Para simplificar escribiremos \lstinline{P $\equiv$ Q} para expresar que un tipo es equivalente a un \lstinline{TyTree} aunque no sea técnicamente correcto en Coq.

\begin{lstlisting}
f : nat -> nat -> nat
\end{lstlisting}

Su tipo traducido es

\begin{lstlisting}
f : \tyTree_imp (\tyTree_base nat) (\tyTree_imp (\tyTree_base nat) (\tyTree_base nat))
\end{lstlisting}

Dado que no hay dependencias de tipos, podemos utilizar \lstinline{\tyTree_imp}. Ahora si parametrizamos
$\nat$ por cualquier tipo.

\begin{lstlisting}
\forall A, A -> A -> A
$\equiv$
\tyTree_FAType (fun A => \tyTree_imp (\tyTree_base A) (\tyTree_imp (\tyTree_base A) (\tyTree_base A))
\end{lstlisting}

Con \lstinline{\tyTree_FAType} podemos observar claramente la dependencia de \lstinline{A}.

Para expresar la dependencia de un valor utilizamos \lstinline{\tyTree_FAValue}.

\begin{lstlisting}
\forall A (B : A -> Type) (a : A), (B a)
$\equiv$
\tyTree_FAType (fun A => \tyTree_FAType (fun B : A -> Type => \tyTree_FAValue A (fun a => \tyTree_base (B a))))
\end{lstlisting}

El centro de nuestro trabajo son las funciones monádicas, esto significa utilizar \lstinline{\tyTree_M}.

\begin{lstlisting}
ret : \forall A, A -> M A
$\equiv$
ret : \tyTree_FAType (fun A => \tyTree_imp (\tyTree_base A) (\tyTree_M A))
\end{lstlisting}

Es importante notar que podemos encontrar usos de \lstinline{\tyTree_M} en múltiples secciones de la signatura, solo se matcheará \lstinline{\tyTree_M} en \lift con el retorno de la función. 

% TODO: dejo los otros para después? Leer comentarios de la agenda del 14 de enero.
% TODO: hablar de to_ty y to_tree, ya que con to_ty expresamos cosas importantes.

% TODO: el tipo de lift.
\subsection{El tipo de \lift}

Analicemos la definición de \lift.

\begin{lstlisting}
Fixpoint lift (m : MTele) (U : ArgsOf m) (p l : bool) (T : TyTree) :
  forall (f : to_ty T), M m:{ T : TyTree & to_ty T} := ...
\end{lstlisting}

Dentro de esta signatura vemos elementos conocidos como el telescopio \lstinline{m : MTele} que anuncia las dependencias, un \lstinline{T : TyTree} que representa el tipo de la función a \textit{liftear} y la \lstinline{f : to_ty T} de tipo \lstinline{T}.
También conocemos
\begin{lstlisting}
M m:{ T : TyTree & to_ty T}
(* $\Sigma$-type con un tipo y un elemento del mismo *)
\end{lstlisting}

En el retorno conseguimos un nuevo \lstinline{T' : TyTree} que representa la signatura de la función \lstinline{f} lifteada, y un elemento de tipo \lstinline{T'}, es decir, la nueva función.

Ahora, ¿que representan los argumentos que no mencionamos? Es \textbf{fácil} comprender quienes son \lstinline{p} y \lstinline{l}.
\begin{itemize}
    \item \lstinline{p}: la polaridad. Comienza con valor \lstinline{true}. Este solo se modifica cuando matcheamos \lstinline{\tyTree_imp} en \lift. No es útil para \lstinline{lift_in} y representa...
    % TODO: que mierda hace p? En lift_in no veo ningún lugar donde influya
    \begin{itemize}
        \item \lstinline{p = true}:
    \end{itemize}
    \item \lstinline{l}: comienza en \lstinline{false}. Representa si nos encontramos a la derecha o izquierda de una implicación de manera inmediata. Es útil para...
    % TODO: igual que p. No veo para qué. Puede ser un error?
\end{itemize}

En cuanto a \lstinline{U : ArgsOf m}, \lstinline{U} representa los argumentos que el telescopio añade, y es nuestro truco para poder hacer funcionar \lift, ya que nos permite transportar argumentos de manera descurrificada.
Lo que sucede es que, cuando encontremos un tipo \lstinline{A} cualquiera en nuestra función, ese tipo puede o no estar bajo la mónada.
En el caso de estarlo está en nuestro interés modificarlo, es decir, que deje de ser un \lstinline{Type}, siendo dependiente de los argumentos de nuestro telescopio.
Por eso, con \lstinline{U} y otras funciones de telescopios podemos conseguir este comportamiento.

% TODO: hablar de funciones lifteadas y sus tipos, es decir, TyTree's.
\lstinline{TyTrees monádicos}

Ahora que ya vimos los comportamientos de \lift debemos centrarnos en cómo representamos con \lstinline{TyTree} las funciones lifteadas.
Esto significa entender aún más detalles de los tipos que dependen de telescopios.